<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ICS Splitter & Counter Tool</title>
<style>
  :root {
    --bg-color: #0d1117;
    --card-bg: #161b22;
    --text-color: #e6edf3;
    --accent-blue: #1f6feb;
    --hover-blue: #388bfd;
    --border-color: #30363d;
    --warning-bg: #2d271a;
    --warning-border: #a18010;
    --warning-text: #e6edf3;
    --warning-header: #f1e05a;
    --link-color: #58a6ff;
  }

  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: var(--bg-color);
    color: var(--text-color);
    padding: 2rem;
    max-width: 650px;
    margin: auto;
  }

  h1 {
    color: var(--accent-blue);
    text-align: center;
  }

  input[type="file"], 
  input[type="number"], 
  button {
    margin-top: 0.8rem;
    padding: 0.7rem;
    font-size: 1rem;
    width: 100%;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: var(--card-bg);
    color: var(--text-color);
    box-sizing: border-box;
    transition: 0.2s ease;
  }

  input[type="number"]:focus, 
  input[type="file"]:focus {
    outline: none;
    border-color: var(--accent-blue);
  }

  button {
    background-color: var(--accent-blue);
    border: none;
    font-weight: 600;
    cursor: pointer;
  }

  button:hover {
    background-color: var(--hover-blue);
  }

  .output {
    margin-top: 1.5rem;
    background: var(--card-bg);
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid var(--border-color);
  }

  pre {
    background: #0c0f14;
    color: #9ecbff;
    padding: 1rem;
    border-radius: 6px;
    overflow-x: auto;
    white-space: pre-wrap;
  }

  p, h3 {
    color: var(--text-color);
  }
  
  code {
    color: var(--link-color);
    background: #0c1117;
    padding: 2px 5px;
    border-radius: 3px;
  }

  .info-box {
    background-color: var(--warning-bg);
    border: 1px solid var(--warning-border);
    padding: 1rem;
    margin-top: 1.5rem;
    border-radius: 6px;
    color: var(--warning-text);
  }

  .info-box h4 {
    margin-top: 0;
    color: var(--warning-header);
    font-weight: 600;
  }
  
  .info-box p {
      margin-bottom: 0.5rem;
  }

  /* Style for the download links */
  .download-links a {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--link-color);
    text-decoration: none;
    padding: 8px;
    background-color: #0c1117;
    border-radius: 4px;
    transition: background-color 0.2s;
  }

  .download-links a:hover {
    background-color: #30363d;
    text-decoration: underline;
  }
</style>
</head>
<body>
  <h1>üìÖ ICS Splitter & Counter</h1>
  <p>Upload your <code>.ics</code> calendar file to count or split events into multiple smaller files.</p>

  <input type="file" id="icsFile" accept=".ics" />
  <br>
  <input type="number" id="splitCount" placeholder="Number of files to split into (e.g., 3)" min="1" />
  <br>
  <button id="countBtn">üî¢ Count Events Only</button>
  <button id="splitBtn">‚úÇÔ∏è Split and Create Download Links</button>

  <div class="output" id="output"></div>
  
  <script>
    // Note: JSZip script is no longer needed and has been removed.
    function showMessage(message, type = 'info') {
        const outputDiv = document.getElementById('output');
        const color = type === 'error' ? '#ff8080' : 'var(--text-color)';
        outputDiv.innerHTML = `<p style="color: ${color};">${message}</p>`;
    }

    async function readICSFile() {
      const fileInput = document.getElementById("icsFile");
      if (!fileInput.files.length) {
        showMessage("Please select an .ics file first.", "error");
        return null;
      }
      const file = fileInput.files[0];
      const text = await file.text();
      return text;
    }

    document.getElementById("countBtn").addEventListener("click", async () => {
      const text = await readICSFile();
      if (!text) return;

      const events = text.match(/BEGIN:VEVENT[\s\S]*?END:VEVENT/g);
      const total = events ? events.length : 0;

      document.getElementById("output").innerHTML = `
        <h3>üìä Event Count</h3>
        <p>Total events found: <b style="color: var(--accent-blue)">${total}</b></p>
      `;
    });

    document.getElementById("splitBtn").addEventListener("click", async () => {
      const text = await readICSFile();
      if (!text) return;

      const splitCount = parseInt(document.getElementById("splitCount").value);
      if (!splitCount || splitCount < 1) {
        showMessage("Please enter a valid number of files to split into.", "error");
        return;
      }

      const events = text.match(/BEGIN:VEVENT[\s\S]*?END:VEVENT/g);
      if (!events || events.length === 0) {
        showMessage("No events were found in this .ics file.", "error");
        return;
      }

      const totalEvents = events.length;
      const perFile = Math.ceil(totalEvents / splitCount);
      const calendarHeader = text.match(/BEGIN:VCALENDAR[\s\S]*?(?=BEGIN:VEVENT)/i)?.[0] || 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Gemini//ICS Splitter//EN\nCALSCALE:GREGORIAN\n';

      // Prepare the output area
      const outputDiv = document.getElementById("output");
      outputDiv.innerHTML = `
        <h3>‚úÖ Split Complete</h3>
        <p>Total events processed: <b style="color: var(--accent-blue)">${totalEvents}</b></p>
        <p><b>Click the links below to download each file:</b></p>
        <div class="download-links" id="downloadLinks"></div>
        <div class="info-box">
          <h4>üìù A Note on Security Warnings</h4>
          <p>Windows might show a security warning for downloaded files. This is a standard safety feature.</p>
          <p>If you trust your original file, these new files are safe. You may need to <b>right-click</b> each file, go to <b>Properties</b>, and check the <b>"Unblock"</b> box.</p>
        </div>
      `;
      
      const downloadLinksContainer = document.getElementById("downloadLinks");

      for (let i = 0; i < splitCount; i++) {
        const start = i * perFile;
        const end = start + perFile;
        const chunk = events.slice(start, end);
        if (chunk.length === 0) break;

        const icsContent =
          calendarHeader +
          chunk.join("\n") +
          "\nEND:VCALENDAR";

        const filename = `split_${i + 1}.ics`;
        
        // Create a blob and an object URL for the link
        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8;' });
        const url = URL.createObjectURL(blob);

        // Create the clickable link element
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.textContent = `${filename} (${chunk.length} events)`;
        
        // Add the link to our container
        downloadLinksContainer.appendChild(a);
      }
    });
  </script>
</body>
</html>